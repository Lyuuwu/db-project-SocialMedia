<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mini IG Demo</title>
  <style>
    :root{
      --bg1:#0b1020; --bg2:#111827;
      --stroke: rgba(255,255,255,.16);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.65);
      --brand: #60a5fa; --brand2:#a78bfa;
      --ok:#34d399; --err:#fb7185;
      --shadow: 0 18px 70px rgba(0,0,0,.45);
      --r: 18px; --r2: 12px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; min-height:100vh; color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
      background:
        radial-gradient(950px 520px at 10% 10%, rgba(96,165,250,.22), transparent 55%),
        radial-gradient(900px 520px at 90% 15%, rgba(167,139,250,.18), transparent 55%),
        radial-gradient(900px 600px at 55% 110%, rgba(52,211,153,.10), transparent 60%),
        linear-gradient(135deg, var(--bg1), var(--bg2));
    }
    .wrap{ max-width:1100px; margin:0 auto; padding:18px 16px 60px; }

    /* Topbar */
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      margin-bottom:16px;
    }
    .leftTop{ display:flex; align-items:center; gap:10px; }
    .avatarBtn{
      width:40px; height:40px; border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      display:grid; place-items:center;
      cursor:pointer;
      box-shadow: 0 18px 45px rgba(0,0,0,.25);
      backdrop-filter: blur(10px);
      user-select:none;
    }
    .avatarBtn:hover{ background: rgba(255,255,255,.10); }
    .avatarDot{
      width:10px; height:10px; border-radius:999px;
      background: rgba(255,255,255,.25);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.22);
      margin-left:6px;
    }
    .avatarDot.ok{ background: rgba(52,211,153,.9); }
    .avatarDot.err{ background: rgba(251,113,133,.9); }
    .brand{
      display:flex; align-items:center; gap:10px;
      user-select:none;
    }
    .logo{
      width:42px; height:42px; border-radius:14px;
      background: linear-gradient(135deg, rgba(96,165,250,.95), rgba(167,139,250,.95));
      box-shadow: 0 18px 45px rgba(96,165,250,.18);
      display:grid; place-items:center;
      font-weight:900;
    }
    .brand h1{ margin:0; font-size:16px; line-height:1.1; }
    .brand p{ margin:4px 0 0; font-size:12px; color:var(--muted); }

    .statusPill{
      display:flex; align-items:center; gap:10px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      padding:10px 12px; border-radius:999px;
      backdrop-filter: blur(10px);
    }
    .dot{ width:10px; height:10px; border-radius:999px; background:rgba(255,255,255,.25); }
    .dot.ok{ background: rgba(52,211,153,.9); }
    .dot.err{ background: rgba(251,113,133,.9); }
    .statusPill span{ font-size:12px; color:var(--muted); }

    /* Layout (only main feed now) */
    .grid{ display:grid; grid-template-columns: 1fr; gap:16px; }

    .card{
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.11), rgba(255,255,255,.06));
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .head{
      padding:16px 16px 10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex; justify-content:space-between; align-items:flex-start; gap:10px;
    }
    .head h2{ margin:0; font-size:13px; letter-spacing:.3px; }
    .head p{ margin:6px 0 0; font-size:12px; color:var(--muted); line-height:1.35; }
    .body{ padding:14px 16px 16px; }

    .row{
      display:grid;
      grid-template-columns: 120px 1fr;
      gap:10px; align-items:center;
      margin:10px 0;
    }
    .row label{ font-size:12px; color:var(--muted); }
    input, textarea{
      width:100%;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(17,24,39,.35);
      color: var(--text);
      padding:10px 12px;
      outline:none;
    }
    textarea{ min-height: 92px; resize: vertical; }
    input::placeholder, textarea::placeholder{ color: rgba(255,255,255,.35); }

    .actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    .btn{
      border:none; border-radius: 999px;
      padding:10px 14px; cursor:pointer;
      font-weight:700; font-size:12px; letter-spacing:.2px;
      color:rgba(255,255,255,.95);
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.18);
    }
    .btn.primary{
      background: linear-gradient(135deg, rgba(96,165,250,.95), rgba(167,139,250,.90));
      border: none;
      box-shadow: 0 16px 40px rgba(96,165,250,.20);
    }
    .btn.ghost{ background: rgba(255,255,255,.04); }
    .btn.danger{
      background: rgba(251,113,133,.15);
      border-color: rgba(251,113,133,.35);
    }
    .hint{ margin-top:10px; font-size:12px; color:var(--muted); line-height:1.45; }
    .msg{
      margin-top:10px; padding:10px 12px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      font-size:12px;
      color: var(--muted);
      display:none;
    }
    .msg.ok{ border-color: rgba(52,211,153,.35); background: rgba(52,211,153,.10); color: rgba(255,255,255,.88); }
    .msg.err{ border-color: rgba(251,113,133,.35); background: rgba(251,113,133,.10); color: rgba(255,255,255,.88); }

    .feedControls{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .search{ flex:1; min-width:160px; }
    .badge{
      padding:3px 8px; border-radius: 999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      font-size: 11px;
    }
    .feed{ display:flex; flex-direction:column; gap:12px; padding:14px 16px 18px; }
    .postCard{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      border-radius: var(--r2);
      overflow:hidden;
    }
    .postMeta{
      padding:12px 12px 0;
      display:flex; justify-content:space-between; gap:10px;
    }
    .nameLine{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; font-size:12px; }
    .time{ font-size:11px; color: var(--muted); white-space:nowrap; }
    .postBody{
      padding:10px 12px 12px;
      color: rgba(255,255,255,.88);
      font-size:13px; line-height:1.45;
      white-space:pre-wrap; word-break:break-word;
    }
    .imgWrap{ border-top:1px solid rgba(255,255,255,.10); background: rgba(0,0,0,.12); }
    .imgWrap img{ width:100%; display:block; max-height: 420px; object-fit: cover; }
    .footerBar{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      padding:10px 12px 12px;
      border-top:1px solid rgba(255,255,255,.10);
      color: var(--muted); font-size:12px;
    }
    code{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size: 11px; }

    /* Modal */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
      display:none;
      align-items:center; justify-content:center;
      padding:18px;
      z-index: 50;
    }
    .overlay.open{ display:flex; }
    .modal{
      width: min(520px, 100%);
      border:1px solid rgba(255,255,255,.18);
      background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.07));
      border-radius: 22px;
      box-shadow: 0 30px 120px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modalTop{
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .modalTop .title{
      display:flex; align-items:center; gap:10px;
    }
    .miniLogo{
      width:34px; height:34px; border-radius:12px;
      background: linear-gradient(135deg, rgba(96,165,250,.95), rgba(167,139,250,.95));
      display:grid; place-items:center;
      font-weight:900;
    }
    .closeBtn{
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius: 999px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:700;
      font-size:12px;
    }
    .tabs{
      display:flex; gap:8px; flex-wrap:wrap;
      padding:12px 16px 0;
    }
    .tab{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.05);
      color:var(--text);
      padding:8px 10px;
      border-radius:999px;
      font-size:12px; cursor:pointer; user-select:none;
    }
    .tab.active{
      border-color: rgba(96,165,250,.55);
      background: rgba(96,165,250,.15);
    }
    .modalBody{ padding:12px 16px 16px; }
    .dividerLine{
      height:1px; background: rgba(255,255,255,.10);
      margin:12px 0;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="leftTop">
        <!-- Left-top icon (opens login/register modal) -->
        <div class="avatarBtn" onclick="openAuth()" title="登入 / 註冊">
          <!-- simple user icon -->
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M20 21a8 8 0 0 0-16 0" stroke="rgba(255,255,255,.88)" stroke-width="2" stroke-linecap="round"/>
            <path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4Z" stroke="rgba(255,255,255,.88)" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
        <div class="avatarDot" id="loginDot" title="登入狀態"></div>

        <div class="brand">
          <div class="logo">MI</div>
          <div>
            <h1>Mini IG Demo</h1>
            <p>點左上角頭像 → 登入/註冊彈窗（不輸入任何 _id）</p>
          </div>
        </div>
      </div>

      <div class="statusPill">
        <div id="apiDot" class="dot"></div>
        <span id="apiText">尚未測試後端連線</span>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="head">
          <div>
            <h2>貼文牆</h2>
            <p>登入後可發文；刷新會呼叫 <code>GET /api/posts</code>。</p>
          </div>
          <div class="feedControls">
            <input id="search" class="search" placeholder="搜尋（content / user_name / Email）" oninput="renderFeed()" />
            <button class="btn" onclick="loadPosts()">刷新</button>
            <button class="btn ghost" onclick="pingBackend()">測試後端</button>
          </div>
        </div>

        <div class="body">
          <!-- Composer -->
          <div class="card" style="box-shadow:none; background:rgba(255,255,255,.05); border-radius:14px;">
            <div class="head" style="border-bottom:1px solid rgba(255,255,255,.10);">
              <div>
                <h2>發一篇貼文</h2>
                <p>呼叫 <code>POST /api/posts</code>（不傳 post_id）</p>
              </div>
              <div class="badge" id="whoami">未登入（點左上角頭像登入）</div>
            </div>
            <div class="body">
              <div class="row">
                <label>picture</label>
                <input id="postPic" maxlength="255" placeholder="圖片 URL（可空）" />
              </div>
              <div class="row">
                <label>content*</label>
                <textarea id="postContent" maxlength="500" placeholder="想說些什麼？"></textarea>
              </div>

              <div class="actions">
                <button class="btn primary" onclick="createPost()">發文</button>
                <button class="btn ghost" onclick="fillDemo()">填入範例</button>
                <button class="btn danger" onclick="logout()">登出</button>
              </div>

              <div id="postMsg" class="msg"></div>
            </div>
          </div>

          <div style="height:12px;"></div>

          <div class="feed" id="feed"></div>

          <div class="hint" style="padding:0 16px 16px;">
            你後端回貼文陣列每筆建議包含：<code>{content, time, likes, picture, user_name}</code>。
            若有回 post_id/user_id，前端可拿來顯示但不讓使用者填。
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Auth Modal -->
  <div id="overlay" class="overlay" onclick="overlayClick(event)">
    <div class="modal" role="dialog" aria-modal="true" aria-label="登入註冊">
      <div class="modalTop">
        <div class="title">
          <div class="miniLogo">MI</div>
          <div>
            <div style="font-weight:900; font-size:13px;">登入 / 註冊</div>
            <div style="font-size:12px; color:var(--muted);">使用者不輸入任何 _id</div>
          </div>
        </div>
        <button class="closeBtn" onclick="closeAuth()">關閉</button>
      </div>

      <div class="tabs">
        <div id="tabLogin" class="tab active" onclick="uiSetTab('login')">登入</div>
        <div id="tabRegister" class="tab" onclick="uiSetTab('register')">註冊</div>
      </div>

      <div class="modalBody">
        <!-- LOGIN -->
        <div id="panelLogin">
          <div class="row">
            <label>Email</label>
            <input id="loginEmail" placeholder="example@mail.com" />
          </div>
          <div class="row">
            <label>password</label>
            <input id="loginPwd" type="password" placeholder="至少 10 字元" maxlength="20" />
          </div>

          <div class="actions">
            <button class="btn primary" onclick="login()">登入</button>
            <button class="btn" onclick="pingBackend()">測試後端</button>
          </div>

          <div id="authMsg" class="msg"></div>

          <div class="hint">
            登入 API：<code>POST /api/login</code> body：<code>{Email, password}</code><br/>
            後端成功後回傳 user（可含 user_id / user_name / token）。
          </div>
        </div>

        <!-- REGISTER -->
        <div id="panelRegister" style="display:none;">
          <div class="row"><label>user_name*</label><input id="regUserName" maxlength="20" placeholder="你的暱稱" /></div>
          <div class="row"><label>Email*</label><input id="regEmail" maxlength="50" placeholder="example@mail.com" /></div>
          <div class="row"><label>password*</label><input id="regPwd" maxlength="20" type="password" placeholder=">= 10 字元（DB 有 check）" /></div>
          <div class="row"><label>bio</label><input id="regBio" maxlength="200" placeholder="一句自介（可空）" /></div>
          <div class="row"><label>profile_pic</label><input id="regPic" maxlength="255" placeholder="頭像 URL（可空）" /></div>

          <div class="actions">
            <button class="btn primary" onclick="register()">註冊</button>
            <button class="btn" onclick="pingBackend()">測試後端</button>
          </div>

          <div id="regMsg" class="msg"></div>

          <div class="hint">
            註冊 API：<code>POST /api/register</code> body：<code>{user_name, Email, password, bio, profile_pic}</code><br/>
            user_id 由後端/DB 生成，不在 UI 出現。
          </div>
        </div>

        <div class="dividerLine"></div>
        <div class="hint" style="margin-top:0;">
          你只要在最下方把 <code>BASE_URL</code> 改成你同學後端（ngrok/tunnel）網址就能連。
        </div>
      </div>
    </div>
  </div>

<script>
/** ========= 必改：後端網址 =========
 * ngrok 例：https://abc123.ngrok-free.app
 * 同網段測試例：http://192.168.0.23:5000
 */
const BASE_URL = "http://127.0.0.1:5000"; // ← 改成你同學後端網址

const API = {
  ping: "/db_test",           // GET
  register: "/api/register",  // POST
  login: "/api/login",        // POST
  posts: "/api/posts",        // GET/POST
};

let postsCache = [];
const $ = (id) => document.getElementById(id);

function showMsg(el, type, text){
  el.className = "msg " + (type || "");
  el.textContent = text || "";
  el.style.display = text ? "block" : "none";
}

function setApiStatus(ok, text){
  const dot = $("apiDot");
  const t = $("apiText");
  dot.classList.remove("ok","err");
  dot.classList.add(ok ? "ok" : "err");
  t.textContent = text;
}

function setLoginDot(){
  const u = getSession();
  const dot = $("loginDot");
  dot.classList.remove("ok","err");
  dot.classList.add(u ? "ok" : "err");
}

function escapeHtml(str){
  return String(str ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;");
}

function fmtTime(t){
  try{
    const d = new Date(t);
    if (isNaN(d)) return "";
    return d.toLocaleString();
  }catch{ return ""; }
}

function getSession(){
  const raw = localStorage.getItem("miniig_user");
  return raw ? JSON.parse(raw) : null;
}

function setSession(user){
  if (!user) localStorage.removeItem("miniig_user");
  else localStorage.setItem("miniig_user", JSON.stringify(user));
  syncWhoAmI();
}

function syncWhoAmI(){
  const u = getSession();
  $("whoami").textContent = u ? (u.user_name || u.Email || "已登入") : "未登入（點左上角頭像登入）";
  setLoginDot();
}

/* Modal open/close */
function openAuth(){
  $("overlay").classList.add("open");
  // default focus
  setTimeout(()=> $("loginEmail")?.focus(), 0);
}
function closeAuth(){
  $("overlay").classList.remove("open");
  showMsg($("authMsg"), "", "");
  showMsg($("regMsg"), "", "");
}
function overlayClick(e){
  // click outside modal to close
  if (e.target.id === "overlay") closeAuth();
}
window.addEventListener("keydown", (e)=>{
  if (e.key === "Escape") closeAuth();
});

/* Tabs */
function uiSetTab(tab){
  const isLogin = (tab === "login");
  $("tabLogin").classList.toggle("active", isLogin);
  $("tabRegister").classList.toggle("active", !isLogin);
  $("panelLogin").style.display = isLogin ? "block" : "none";
  $("panelRegister").style.display = isLogin ? "none" : "block";
}

/* API helper */
async function apiFetch(path, options={}){
  const url = BASE_URL.replace(/\/$/,"") + path;
  const headers = Object.assign({ "Content-Type":"application/json" }, options.headers || {});
  const opts = Object.assign({}, options, { headers });

  const u = getSession();
  if (u?.token) headers.Authorization = `Bearer ${u.token}`;

  const res = await fetch(url, opts);
  let data = null;
  try { data = await res.json(); } catch { data = null; }
  if (!res.ok){
    const msg = data?.error || data?.message || `HTTP ${res.status}`;
    throw new Error(msg);
  }
  return data;
}

/* Actions */
async function pingBackend(){
  try{
    const data = await apiFetch(API.ping, { method:"GET" });
    setApiStatus(true, `後端 OK：${data?.db_name ?? "db"} / ${data?.login ?? "login"}`);
  }catch(e){
    setApiStatus(false, `後端失敗：${e.message}`);
  }
}

async function register(){
  const msg = $("regMsg");
  showMsg(msg, "", "");

  const payload = {
    user_name: $("regUserName").value.trim(),
    Email: $("regEmail").value.trim(),
    password: $("regPwd").value,
    bio: $("regBio").value.trim(),
    profile_pic: $("regPic").value.trim(),
  };

  if (!payload.user_name || !payload.Email || !payload.password){
    return showMsg(msg, "err", "必填：user_name / Email / password");
  }
  if (payload.password.length < 10){
    return showMsg(msg, "err", "password 至少 10 字元（你的 DB 有 check）");
  }

  try{
    await apiFetch(API.register, { method:"POST", body: JSON.stringify(payload) });
    showMsg(msg, "ok", "註冊成功！請切到登入。");
    uiSetTab("login");
  }catch(e){
    showMsg(msg, "err", `註冊失敗：${e.message}`);
  }
}

async function login(){
  const msg = $("authMsg");
  showMsg(msg, "", "");

  const Email = $("loginEmail").value.trim();
  const password = $("loginPwd").value;
  if (!Email || !password) return showMsg(msg, "err", "請輸入 Email + password");

  try{
    const data = await apiFetch(API.login, { method:"POST", body: JSON.stringify({ Email, password }) });
    const user = data.user || data;
    if (!user) throw new Error("後端回傳格式不對");

    setSession(user);
    showMsg(msg, "ok", `登入成功：${user.user_name || user.Email}`);
    await loadPosts();
    // close modal after a short moment
    setTimeout(()=> closeAuth(), 450);
  }catch(e){
    showMsg(msg, "err", `登入失敗：${e.message}`);
  }
}

function logout(){
  setSession(null);
  showMsg($("postMsg"), "ok", "已登出");
}

async function loadPosts(){
  try{
    const data = await apiFetch(API.posts, { method:"GET" });
    postsCache = Array.isArray(data) ? data : (data.posts || []);
    renderFeed();
    setApiStatus(true, "後端連線正常");
  }catch(e){
    setApiStatus(false, `抓貼文失敗：${e.message}`);
  }
}

async function createPost(){
  const msg = $("postMsg");
  showMsg(msg, "", "");

  const u = getSession();
  if (!u) return showMsg(msg, "err", "請先登入（點左上角頭像）");

  const payload = {
    content: $("postContent").value.trim(),
    picture: $("postPic").value.trim(),
  };
  if (!payload.content) return showMsg(msg, "err", "content 不能空");

  try{
    await apiFetch(API.posts, { method:"POST", body: JSON.stringify(payload) });
    showMsg(msg, "ok", "發文成功！");
    $("postContent").value = "";
    $("postPic").value = "";
    await loadPosts();
  }catch(e){
    showMsg(msg, "err", `發文失敗：${e.message}`);
  }
}

/* Render */
function renderFeed(){
  const q = $("search").value.trim().toLowerCase();
  const feed = $("feed");
  feed.innerHTML = "";

  const list = (postsCache || []).filter(p=>{
    if (!q) return true;
    const s = `${p.content||""} ${p.user_name||""} ${p.Email||""}`.toLowerCase();
    return s.includes(q);
  });

  if (list.length === 0){
    const empty = document.createElement("div");
    empty.className = "msg";
    empty.style.display = "block";
    empty.textContent = "目前沒有貼文（或搜尋結果為空）。";
    feed.appendChild(empty);
    return;
  }

  list.forEach(p=>{
    const card = document.createElement("div");
    card.className = "postCard";

    const name = escapeHtml(p.user_name || "unknown");
    const t = fmtTime(p.time);
    const likes = (p.likes ?? 0);

    const meta = document.createElement("div");
    meta.className = "postMeta";
    meta.innerHTML = `
      <div class="nameLine">
        <b>${name}</b>
        ${p.Email ? `<span class="badge">${escapeHtml(p.Email)}</span>` : ""}
      </div>
      <div class="time">${t}</div>
    `;

    const body = document.createElement("div");
    body.className = "postBody";
    body.innerHTML = escapeHtml(p.content || "");

    card.appendChild(meta);
    card.appendChild(body);

    const pic = (p.picture || "").trim();
    if (pic){
      const imgWrap = document.createElement("div");
      imgWrap.className = "imgWrap";
      imgWrap.innerHTML = `<img src="${escapeHtml(pic)}" alt="post image" />`;
      card.appendChild(imgWrap);
    }

    const footer = document.createElement("div");
    footer.className = "footerBar";
    footer.innerHTML = `<span>likes: ${likes}</span><span class="badge">from API</span>`;
    card.appendChild(footer);

    feed.appendChild(card);
  });
}

function fillDemo(){
  const u = getSession();
  if (!u){
    showMsg($("postMsg"), "err", "先登入（點左上角頭像）");
    return;
  }
  $("postPic").value = "https://images.unsplash.com/photo-1520975682031-a4a2c1a53497?auto=format&fit=crop&w=1200&q=60";
  $("postContent").value = `今天 demo 很順！\n— ${u.user_name || u.Email}`;
}

/* init */
syncWhoAmI();
uiSetTab("login");
pingBackend();
loadPosts().catch(()=>{});
</script>
</body>
</html>