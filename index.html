<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mini IG Demo</title>

  <style>
    :root{
      --bg1:#0b1020; --bg2:#111827;
      --glass1: rgba(255,255,255,.11);
      --glass2: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.16);
      --stroke2: rgba(255,255,255,.10);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.65);
      --brand: #60a5fa; --brand2:#a78bfa;
      --ok:#34d399; --err:#fb7185;
      --shadow: 0 18px 70px rgba(0,0,0,.45);
      --shadow2: 0 12px 35px rgba(0,0,0,.35);
      --r: 18px; --r2: 14px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; min-height:100vh; color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
      background:
        radial-gradient(950px 520px at 10% 10%, rgba(96,165,250,.22), transparent 55%),
        radial-gradient(900px 520px at 90% 15%, rgba(167,139,250,.18), transparent 55%),
        radial-gradient(900px 600px at 55% 110%, rgba(52,211,153,.10), transparent 60%),
        linear-gradient(135deg, var(--bg1), var(--bg2));
    }
    .wrap{ max-width:1100px; margin:0 auto; padding:18px 16px 90px; }

    /* top */
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; margin-bottom:16px;
    }
    .leftTop{ display:flex; align-items:center; gap:12px; }
    .avatarBtn{
      width:40px; height:40px; border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      display:grid; place-items:center;
      cursor:pointer; user-select:none;
      box-shadow: 0 18px 45px rgba(0,0,0,.25);
      backdrop-filter: blur(10px);
    }
    .avatarBtn:hover{ background: rgba(255,255,255,.10); }
    .loginDot{
      width:10px; height:10px; border-radius:999px;
      background: rgba(255,255,255,.25);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.22);
    }
    .loginDot.ok{ background: rgba(52,211,153,.9); }
    .loginDot.err{ background: rgba(251,113,133,.9); }

    .brand{ display:flex; align-items:center; gap:10px; user-select:none; }
    .logo{
      width:42px; height:42px; border-radius:14px;
      background: linear-gradient(135deg, rgba(96,165,250,.95), rgba(167,139,250,.95));
      box-shadow: 0 18px 45px rgba(96,165,250,.18);
      display:grid; place-items:center; font-weight:900;
    }
    .brand h1{ margin:0; font-size:16px; line-height:1.1; }
    .brand p{ margin:4px 0 0; font-size:12px; color:var(--muted); }

    .statusPill{
      display:flex; align-items:center; gap:10px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      padding:10px 12px; border-radius:999px;
      backdrop-filter: blur(10px);
    }
    .dot{ width:10px; height:10px; border-radius:999px; background:rgba(255,255,255,.25); }
    .dot.ok{ background: rgba(52,211,153,.9); }
    .dot.err{ background: rgba(251,113,133,.9); }
    .statusPill span{ font-size:12px; color:var(--muted); white-space:nowrap; }

    /* cards */
    .card{
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, var(--glass1), var(--glass2));
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .head{
      padding:16px 16px 10px;
      border-bottom:1px solid var(--stroke2);
      display:flex; justify-content:space-between; align-items:flex-start; gap:10px;
    }
    .head h2{ margin:0; font-size:13px; letter-spacing:.3px; }
    .head p{ margin:6px 0 0; font-size:12px; color:var(--muted); line-height:1.35; }
    .body{ padding:14px 16px 16px; }

    .feedControls{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .search{
      flex:1; min-width:220px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(17,24,39,.35);
      color: var(--text);
      padding:10px 12px;
      outline:none;
    }
    .search::placeholder{ color: rgba(255,255,255,.35); }

    .btn{
      border:none; border-radius: 999px;
      padding:10px 14px; cursor:pointer;
      font-weight:800; font-size:12px; letter-spacing:.2px;
      color:rgba(255,255,255,.95);
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.18);
      user-select:none;
    }
    .btn:hover{ background: rgba(255,255,255,.14); }
    .btn.primary{
      background: linear-gradient(135deg, rgba(96,165,250,.95), rgba(167,139,250,.90));
      border: none;
      box-shadow: 0 16px 40px rgba(96,165,250,.20);
    }
    .btn.ghost{ background: rgba(255,255,255,.04); }
    .btn.danger{
      background: rgba(251,113,133,.15);
      border-color: rgba(251,113,133,.35);
    }

    .msg{
      margin-top:10px; padding:10px 12px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      font-size:12px;
      color: var(--muted);
      display:none;
    }
    .msg.ok{ border-color: rgba(52,211,153,.35); background: rgba(52,211,153,.10); color: rgba(255,255,255,.88); }
    .msg.err{ border-color: rgba(251,113,133,.35); background: rgba(251,113,133,.10); color: rgba(255,255,255,.88); }

    .hint{ margin-top:10px; font-size:12px; color:var(--muted); line-height:1.45; }

    /* feed */
    .feed{ display:flex; flex-direction:column; gap:12px; padding:14px 16px 18px; }
    .postCard{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      border-radius: var(--r2);
      overflow:hidden;
      box-shadow: var(--shadow2);
    }
    .postMeta{
      padding:12px 12px 0;
      display:flex; justify-content:space-between; gap:10px;
    }
    .nameLine{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; font-size:12px; }
    .badge{
      padding:3px 8px; border-radius: 999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      font-size: 11px;
    }
    .time{ font-size:11px; color: var(--muted); white-space:nowrap; }
    .postBody{
      padding:10px 12px 12px;
      color: rgba(255,255,255,.90);
      font-size:13px; line-height:1.55;
      white-space:pre-wrap; word-break:break-word;
    }
    .imgWrap{ border-top:1px solid rgba(255,255,255,.10); background: rgba(0,0,0,.12); }
    .imgWrap img{ width:100%; display:block; max-height: 460px; object-fit: cover; }
    .footerBar{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      padding:10px 12px 12px;
      border-top:1px solid rgba(255,255,255,.10);
      color: var(--muted); font-size:12px;
    }

    /* create page */
    .formGrid{
      display:grid;
      grid-template-columns: 120px 1fr;
      gap:10px;
      align-items:start;
      margin:10px 0;
    }
    .formGrid label{
      font-size:12px;
      color:var(--muted);
      padding-top:10px;
    }
    input, textarea{
      width:100%;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(17,24,39,.35);
      color: var(--text);
      padding:10px 12px;
      outline:none;
    }
    textarea{ min-height: 120px; resize: vertical; }
    input::placeholder, textarea::placeholder{ color: rgba(255,255,255,.35); }
    .miniRow{
      display:flex; justify-content:space-between; align-items:center;
      gap:10px;
      margin-top:8px;
      color: var(--muted);
      font-size:12px;
    }
    .chip{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      font-size:12px;
      color: rgba(255,255,255,.85);
      user-select:none;
      cursor:pointer;
    }

    /* modal */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
      display:none;
      align-items:center; justify-content:center;
      padding:18px;
      z-index: 50;
    }
    .overlay.open{ display:flex; }
    .modal{
      width: min(520px, 100%);
      border:1px solid rgba(255,255,255,.18);
      background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.07));
      border-radius: 22px;
      box-shadow: 0 30px 120px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modalTop{
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .title{ display:flex; align-items:center; gap:10px; }
    .miniLogo{
      width:34px; height:34px; border-radius:12px;
      background: linear-gradient(135deg, rgba(96,165,250,.95), rgba(167,139,250,.95));
      display:grid; place-items:center;
      font-weight:900;
    }
    .closeBtn{
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius: 999px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:800;
      font-size:12px;
    }
    .tabs{
      display:flex; gap:8px; flex-wrap:wrap;
      padding:12px 16px 0;
    }
    .tab{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.05);
      color:var(--text);
      padding:8px 10px;
      border-radius:999px;
      font-size:12px; cursor:pointer; user-select:none;
      font-weight:800;
    }
    .tab.active{
      border-color: rgba(96,165,250,.55);
      background: rgba(96,165,250,.15);
    }
    .modalBody{ padding:12px 16px 16px; }

    /* bottom nav */
    .bottomNav{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 14px;
      width: min(620px, calc(100% - 24px));
      border:1px solid rgba(255,255,255,.16);
      background: rgba(17,24,39,.55);
      backdrop-filter: blur(12px);
      border-radius: 999px;
      box-shadow: 0 20px 80px rgba(0,0,0,.45);
      display:flex;
      padding: 8px;
      gap: 8px;
      z-index: 40;
    }
    .navItem{
      flex:1;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.88);
      border-radius: 999px;
      padding: 10px 12px;
      cursor: pointer;
      font-weight: 900;
      font-size: 12px;
      display:flex;
      justify-content:center;
      align-items:center;
      gap: 8px;
      user-select:none;
    }
    .navItem span{ color: rgba(255,255,255,.72); font-weight: 800; }
    .navItem.active{
      border-color: rgba(96,165,250,.55);
      background: rgba(96,165,250,.18);
    }

    code{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size: 11px; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="leftTop">
        <div class="avatarBtn" id="authBtn" title="ç™»å…¥ / è¨»å†Š">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M20 21a8 8 0 0 0-16 0" stroke="rgba(255,255,255,.88)" stroke-width="2" stroke-linecap="round"/>
            <path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4Z" stroke="rgba(255,255,255,.88)" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
        <div class="loginDot" id="loginDot" title="ç™»å…¥ç‹€æ…‹"></div>

        <div class="brand">
          <div class="logo">MI</div>
          <div>
            <h1>Mini IG Demo</h1>
            <p>Home çœ‹æœ€æ–°è²¼æ–‡ | Create ç™¼æ–‡ | ç™»å…¥/è¨»å†Šå½ˆçª—</p>
          </div>
        </div>
      </div>

      <div class="statusPill">
        <div id="apiDot" class="dot"></div>
        <span id="apiText">å°šæœªæ¸¬è©¦å¾Œç«¯é€£ç·š</span>
      </div>
    </div>

    <div class="card">
      <div class="head">
        <div>
          <h2 id="pageTitle">é¦–é ï½œæœ€æ–°è²¼æ–‡</h2>
          <p id="pageDesc">é¡¯ç¤ºæ‰€æœ‰è²¼æ–‡ï¼Œä¾ time ç”±æ–°åˆ°èˆŠæ’åºã€‚</p>
        </div>
        <div class="feedControls">
          <input id="search" class="search" placeholder="æœå°‹ï¼ˆcontent / user_name / Emailï¼‰" oninput="renderFeed()" />
          <button class="btn" onclick="loadPosts()">åˆ·æ–°</button>
          <button class="btn ghost" onclick="pingBackend()">æ¸¬è©¦å¾Œç«¯</button>
        </div>
      </div>

      <div class="body">
        <!-- HOME -->
        <div id="pageHome">
          <div class="feed" id="feed"></div>
        </div>

        <!-- CREATE -->
        <div id="pageCreate" style="display:none;">
          <div class="card" style="box-shadow:none; background:rgba(255,255,255,.05); border-radius:16px;">
            <div class="head" style="border-bottom:1px solid rgba(255,255,255,.10);">
              <div>
                <h2>ç™¼ä½ˆè²¼æ–‡</h2>
                <p>å…§å®¹ï¼‹æœ¬æ©Ÿåœ–ç‰‡ï¼ˆå¯é¸ï¼‰ã€‚é€å‡ºå¾Œæœƒåˆ‡å› Homeã€‚</p>
              </div>
              <div class="badge" id="whoami">æœªç™»å…¥ï¼ˆé»å·¦ä¸Šè§’é ­åƒç™»å…¥ï¼‰</div>
            </div>

            <div class="body">
              <!-- âœ… æ”¹æˆï¼šæœ¬æ©Ÿåœ–ç‰‡ -->
              <div class="formGrid">
                <label>åœ–ç‰‡</label>
                <div>
                  <input id="postFile" type="file" accept="image/*" />
                  <div class="miniRow">
                    <span>é¸æ“‡ä½ è£ç½®ä¸­çš„åœ–ç‰‡ï¼ˆå¯ç•™ç©ºï¼‰</span>
                    <span class="chip" onclick="clearPostImage()">æ¸…é™¤</span>
                  </div>

                  <div id="previewBox" style="margin-top:10px; display:none;">
                    <div class="badge" style="margin-bottom:6px;">åœ–ç‰‡é è¦½</div>
                    <img id="previewImg"
                      style="width:100%; max-height:420px; object-fit:cover;
                            border-radius:14px; border:1px solid rgba(255,255,255,.15);" />
                  </div>

                  <div class="hint">
                    ç™¼æ–‡æ™‚æœƒå…ˆå‘¼å« <code>POST /api/upload</code> ä¸Šå‚³åœ–ç‰‡ï¼Œå›å‚³ <code>url</code> å¾Œå†å»ºç«‹è²¼æ–‡ã€‚
                  </div>
                </div>
              </div>

              <div class="formGrid">
                <label>å…§å®¹*</label>
                <div>
                  <textarea id="postContent" maxlength="500" placeholder="æƒ³èªªäº›ä»€éº¼ï¼Ÿ"></textarea>
                  <div class="miniRow">
                    <span id="charCount">0 / 500</span>
                    <span class="badge">POST /api/v1/posts</span>
                  </div>
                </div>
              </div>

              <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;">
                <button class="btn primary" onclick="createPost()">ç™¼ä½ˆ</button>
                <button class="btn ghost" onclick="showPage('home')">å›åˆ°é¦–é </button>
                <button class="btn danger" onclick="logout()">ç™»å‡º</button>
              </div>

              <div id="postMsg" class="msg"></div>
              <div class="hint">
                ä½¿ç”¨è€…ä¸æœƒè¼¸å…¥ä»»ä½• <code>_id</code>ï¼›postId / userId ç”±å¾Œç«¯æˆ– DB ç”¢ç”Ÿã€‚<br/>
                è‹¥å¾Œç«¯æœ‰ tokenï¼Œå‰ç«¯æœƒè‡ªå‹•å¸¶ <code>Authorization: Bearer &lt;token&gt;</code>ã€‚
              </div>
            </div>
          </div>
        </div>

        <div class="hint" style="padding:0 2px 0; margin-top:14px;">
          å°æç¤ºï¼šè‹¥ä½ çš„æ™‚é–“æ¬„ä½æ˜¯ <code>createdAt</code>ï¼Œæˆ‘å·²ç¶“ç”¨ <code>createdAt || time</code> å…¼å®¹ã€‚
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom Nav -->
  <div class="bottomNav">
    <button class="navItem active" id="navHome" onclick="showPage('home')">ğŸ  <span>Home</span></button>
    <button class="navItem" id="navCreate" onclick="showPage('create')">â• <span>Create</span></button>
  </div>

  <!-- Auth Modal -->
  <div id="overlay" class="overlay" onclick="overlayClick(event)">
    <div class="modal" role="dialog" aria-modal="true" aria-label="ç™»å…¥è¨»å†Š">
      <div class="modalTop">
        <div class="title">
          <div class="miniLogo">MI</div>
          <div>
            <div style="font-weight:900; font-size:13px;">ç™»å…¥ / è¨»å†Š</div>
            <div style="font-size:12px; color:var(--muted);">ä½¿ç”¨è€…ä¸è¼¸å…¥ä»»ä½• _id</div>
          </div>
        </div>
        <button class="closeBtn" onclick="closeAuth()">é—œé–‰</button>
      </div>

      <div class="tabs">
        <div id="tabLogin" class="tab active" onclick="uiSetTab('login')">ç™»å…¥</div>
        <div id="tabRegister" class="tab" onclick="uiSetTab('register')">è¨»å†Š</div>
      </div>

      <div class="modalBody">
        <!-- LOGIN -->
        <div id="panelLogin">
          <div class="formGrid">
            <label>Email</label>
            <input id="loginEmail" placeholder="example@mail.com" />
          </div>
          <div class="formGrid">
            <label>password</label>
            <input id="loginPwd" type="password" placeholder="è‡³å°‘ 6 å­—å…ƒï¼ˆä¾ä½ å¾Œç«¯è¦å‰‡ï¼‰" maxlength="64" />
          </div>
          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
            <button class="btn primary" onclick="login()">ç™»å…¥</button>
            <button class="btn" onclick="pingBackend()">æ¸¬è©¦å¾Œç«¯</button>
          </div>
          <div id="authMsg" class="msg"></div>
          <div class="hint">
            ç™»å…¥ï¼š<code>POST /api/v1/auth/login</code> bodyï¼š<code>{email, password}</code>
          </div>
        </div>

        <!-- REGISTER -->
        <div id="panelRegister" style="display:none;">
          <div class="formGrid"><label>user_name*</label><input id="regUserName" maxlength="20" placeholder="ä½ çš„æš±ç¨±" /></div>
          <div class="formGrid"><label>Email*</label><input id="regEmail" maxlength="50" placeholder="example@mail.com" /></div>
          <div class="formGrid"><label>password*</label><input id="regPwd" maxlength="64" type="password" placeholder="è‡³å°‘ 6 å­—å…ƒï¼ˆä¾ä½ å¾Œç«¯è¦å‰‡ï¼‰" /></div>
          <div class="formGrid"><label>bio</label><input id="regBio" maxlength="200" placeholder="ä¸€å¥è‡ªä»‹ï¼ˆå¯ç©ºï¼‰" /></div>
          <div class="formGrid"><label>profile_pic</label><input id="regPic" maxlength="255" placeholder="é ­åƒ URLï¼ˆå¯ç©ºï¼‰" /></div>

          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
            <button class="btn primary" onclick="register()">è¨»å†Š</button>
            <button class="btn" onclick="pingBackend()">æ¸¬è©¦å¾Œç«¯</button>
          </div>

          <div id="regMsg" class="msg"></div>
          <div class="hint">
            è¨»å†Šï¼š<code>POST /api/v1/auth/register</code> bodyï¼š<code>{email, password, userName}</code><br/>
            ä¹‹å¾Œæœƒç”¨ <code>PATCH /api/v1/users/me</code> æ›´æ–° bio / profilePicï¼ˆè‹¥æœ‰å¡«ï¼‰ã€‚
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/** ========= å¿…æ”¹ï¼šå¾Œç«¯ç¶²å€ =========
 * ä½ ç¾åœ¨é€™è¡Œ location.origin åœ¨ GitHub Pages æœƒè®Šæˆã€Œå‰ç«¯è‡ªå·±çš„ç¶²åŸŸã€â†’ ä¸€å®šé€£ä¸åˆ°ä½ åŒå­¸å¾Œç«¯
 * è«‹æ”¹æˆåƒé€™æ¨£ï¼š
 *   const BASE_URL = "https://abc123.ngrok-free.app";
 */
const BASE_URL = "http://127.0.0.1:5000"; // â† æ”¹æˆä½ åŒå­¸å¾Œç«¯ï¼ˆngrok / å…¬ç¶² IPï¼‰

const API = {
  ping: "/db_test",                  // GET
  register: "/api/v1/auth/register", // POST
  login: "/api/v1/auth/login",       // POST
  me: "/api/v1/users/me",            // GET/PATCH
  posts: "/api/v1/posts",            // GET/POST
  upload: "/api/upload"              // POST (multipart/form-data) -> { url }
};

let postsCache = [];
const $ = (id) => document.getElementById(id);

function showMsg(el, type, text){
  el.className = "msg " + (type || "");
  el.textContent = text || "";
  el.style.display = text ? "block" : "none";
}

function setApiStatus(ok, text){
  const dot = $("apiDot");
  const t = $("apiText");
  dot.classList.remove("ok","err");
  dot.classList.add(ok ? "ok" : "err");
  t.textContent = text;
}

function setLoginDot(){
  const s = getSession();
  const dot = $("loginDot");
  dot.classList.remove("ok","err");
  dot.classList.add(s?.accessToken ? "ok" : "err");
}

function escapeHtml(str){
  return String(str ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;");
}

function fmtTime(t){
  try{
    const d = new Date(t);
    if (isNaN(d)) return "";
    return d.toLocaleString();
  }catch{ return ""; }
}

/* session */
function getSession(){
  const raw = localStorage.getItem("miniig_session");
  return raw ? JSON.parse(raw) : null; // { accessToken, user }
}

function setSession(session){
  if (!session) localStorage.removeItem("miniig_session");
  else localStorage.setItem("miniig_session", JSON.stringify(session));
  syncWhoAmI();
}

function syncWhoAmI(){
  const s = getSession();
  const u = s?.user;
  $("whoami").textContent = u ? (u.userName || u.email || "å·²ç™»å…¥") : "æœªç™»å…¥ï¼ˆé»å·¦ä¸Šè§’é ­åƒç™»å…¥ï¼‰";
  setLoginDot();
}

/* modal */
function openAuth(){ $("overlay").classList.add("open"); }
function closeAuth(){
  $("overlay").classList.remove("open");
  showMsg($("authMsg"), "", "");
  showMsg($("regMsg"), "", "");
}
function overlayClick(e){ if (e.target.id === "overlay") closeAuth(); }
window.addEventListener("keydown", (e)=>{ if (e.key === "Escape") closeAuth(); });

function uiSetTab(tab){
  const isLogin = (tab === "login");
  $("tabLogin").classList.toggle("active", isLogin);
  $("tabRegister").classList.toggle("active", !isLogin);
  $("panelLogin").style.display = isLogin ? "block" : "none";
  $("panelRegister").style.display = isLogin ? "none" : "block";
}

/* page switch */
function showPage(which){
  const isHome = (which === "home");
  $("pageHome").style.display = isHome ? "block" : "none";
  $("pageCreate").style.display = isHome ? "none" : "block";
  $("navHome").classList.toggle("active", isHome);
  $("navCreate").classList.toggle("active", !isHome);

  $("pageTitle").textContent = isHome ? "é¦–é ï½œæœ€æ–°è²¼æ–‡" : "ç™¼æ–‡ï½œå»ºç«‹æ–°è²¼æ–‡";
  $("pageDesc").textContent = isHome
    ? "é¡¯ç¤ºæ‰€æœ‰è²¼æ–‡ï¼Œä¾ time/createdAt ç”±æ–°åˆ°èˆŠæ’åºã€‚"
    : "åœ¨é€™è£¡æ’°å¯«è²¼æ–‡ï¼Œé€å‡ºå¾Œå›åˆ° Homeã€‚";
}

/* API helper */
async function apiFetch(path, options={}){
  const url = BASE_URL.replace(/\/$/,"") + path;
  const headers = Object.assign({ "Content-Type":"application/json" }, options.headers || {});
  const opts = Object.assign({}, options, { headers });

  const s = getSession();
  if (s?.accessToken) headers.Authorization = `Bearer ${s.accessToken}`;

  const res = await fetch(url, opts);

  let data = null;
  try { data = await res.json(); } catch { data = null; }

  if (!res.ok){
    const msg = data?.error?.message || data?.message || `HTTP ${res.status}`;
    throw new Error(msg);
  }
  return data;
}

/* backend ping */
async function pingBackend(){
  try{
    const data = await apiFetch(API.ping, { method:"GET" });
    setApiStatus(true, `å¾Œç«¯ OKï¼š${data?.db ?? data?.db_name ?? "db"} / ${data?.login ?? data?.login_name ?? "login"}`);
  }catch(e){
    setApiStatus(false, `å¾Œç«¯å¤±æ•—ï¼š${e.message}`);
  }
}

/* auth */
async function register(){
  const msg = $("regMsg");
  showMsg(msg, "", "");

  const email = $("regEmail").value.trim();
  const password = $("regPwd").value;
  const userName = $("regUserName").value.trim();

  const bio = $("regBio").value.trim();
  const profilePic = $("regPic").value.trim();

  if (!email || !password || !userName){
    return showMsg(msg, "err", "å¿…å¡«ï¼šemail / password / userName");
  }

  try{
    const data = await apiFetch(API.register, {
      method:"POST",
      body: JSON.stringify({ email, password, userName })
    });

    setSession({ accessToken: data.accessToken, user: data.user });

    if (bio || profilePic){
      const patchBody = {};
      if (bio) patchBody.bio = bio;
      if (profilePic) patchBody.profilePic = profilePic;

      const me = await apiFetch(API.me, {
        method:"PATCH",
        body: JSON.stringify(patchBody),
      });

      setSession({ accessToken: data.accessToken, user: me });
    }

    showMsg(msg, "ok", "è¨»å†ŠæˆåŠŸä¸¦å·²ç™»å…¥ï¼");
    await loadPosts().catch(()=>{});
    setTimeout(()=> closeAuth(), 450);

  }catch(e){
    showMsg(msg, "err", `è¨»å†Šå¤±æ•—ï¼š${e.message}`);
  }
}

async function login(){
  const msg = $("authMsg");
  showMsg(msg, "", "");

  const email = $("loginEmail").value.trim();
  const password = $("loginPwd").value;
  if (!email || !password) return showMsg(msg, "err", "è«‹è¼¸å…¥ email + password");

  try{
    const data = await apiFetch(API.login, {
      method:"POST",
      body: JSON.stringify({ email, password })
    });

    setSession({ accessToken: data.accessToken, user: data.user });

    showMsg(msg, "ok", `ç™»å…¥æˆåŠŸï¼š${data.user.userName || data.user.email}`);
    await loadPosts().catch(()=>{});
    setTimeout(()=> closeAuth(), 450);

  }catch(e){
    showMsg(msg, "err", `ç™»å…¥å¤±æ•—ï¼š${e.message}`);
  }
}

function logout(){
  setSession(null);
  showMsg($("postMsg"), "ok", "å·²ç™»å‡º");
}

/* ====== Image upload + preview ====== */
function clearPostImage(){
  const f = $("postFile");
  if (f) f.value = "";
  $("previewBox").style.display = "none";
  $("previewImg").src = "";
}

$("postFile")?.addEventListener("change", () => {
  const f = $("postFile").files?.[0];
  if (!f) return clearPostImage();
  const url = URL.createObjectURL(f);
  $("previewImg").src = url;
  $("previewBox").style.display = "block";
});

/* posts */
async function loadPosts(){
  try{
    const data = await apiFetch(API.posts + "?page=1&pageSize=50", { method:"GET" });
    postsCache = Array.isArray(data) ? data : (data.items || []);

    // âœ… æœ€æ–°åœ¨æœ€ä¸Šé¢ï¼ˆcreatedAt å„ªå…ˆï¼Œå…¶æ¬¡ timeï¼‰
    postsCache.sort((a,b)=>{
      const ta = new Date(a.createdAt || a.time || 0).getTime();
      const tb = new Date(b.createdAt || b.time || 0).getTime();
      return tb - ta;
    });

    renderFeed();
    setApiStatus(true, "å¾Œç«¯é€£ç·šæ­£å¸¸");
  }catch(e){
    setApiStatus(false, `æŠ“è²¼æ–‡å¤±æ•—ï¼š${e.message}`);
  }
}

async function uploadImageIfNeeded(){
  const s = getSession();
  const file = $("postFile")?.files?.[0];
  if (!file) return ""; // æ²’é¸åœ–ç‰‡

  const fd = new FormData();
  fd.append("file", file);

  const url = BASE_URL.replace(/\/$/,"") + API.upload;
  const headers = {};
  if (s?.accessToken) headers.Authorization = `Bearer ${s.accessToken}`;

  const res = await fetch(url, { method:"POST", body: fd, headers });
  let data = null;
  try { data = await res.json(); } catch { data = null; }

  if (!res.ok){
    throw new Error(data?.error || data?.message || "åœ–ç‰‡ä¸Šå‚³å¤±æ•—");
  }

  // æœŸå¾…å›ï¼š{ url: "/uploads/xxx.jpg" } æˆ– { url: "https://.../uploads/xxx.jpg" }
  return data?.url || "";
}

function normalizeImageUrl(pic){
  const p = (pic || "").trim();
  if (!p) return "";
  if (p.startsWith("http://") || p.startsWith("https://")) return p;
  // ç›¸å°è·¯å¾‘ â†’ è£œæˆå¾Œç«¯å¯è®€
  return BASE_URL.replace(/\/$/,"") + (p.startsWith("/") ? p : ("/" + p));
}

async function createPost(){
  const msg = $("postMsg");
  showMsg(msg, "", "");

  const s = getSession();
  if (!s?.accessToken) return showMsg(msg, "err", "è«‹å…ˆç™»å…¥ï¼ˆé»å·¦ä¸Šè§’é ­åƒï¼‰");

  const content = $("postContent").value.trim();
  if (!content) return showMsg(msg, "err", "content ä¸èƒ½ç©º");

  try{
    // â‘  å…ˆä¸Šå‚³åœ–ç‰‡ï¼ˆå¦‚æœæœ‰é¸ï¼‰
    showMsg(msg, "", "æ­£åœ¨ä¸Šå‚³/é€å‡º...");
    const pictureUrl = await uploadImageIfNeeded();

    // â‘¡ å»ºç«‹è²¼æ–‡
    await apiFetch(API.posts, {
      method:"POST",
      body: JSON.stringify({
        content,
        picture: pictureUrl
      })
    });

    showMsg(msg, "ok", "ç™¼ä½ˆæˆåŠŸï¼");
    $("postContent").value = "";
    clearPostImage();
    updateCharCount();
    showPage("home");
    await loadPosts();
  }catch(e){
    showMsg(msg, "err", `ç™¼æ–‡å¤±æ•—ï¼š${e.message}`);
  }
}

/* render */
function renderFeed(){
  const q = $("search").value.trim().toLowerCase();
  const feed = $("feed");
  feed.innerHTML = "";

  const list = (postsCache || []).filter(p=>{
    if (!q) return true;
    const s = `${p.content||""} ${p.author?.userName||""} ${p.author?.email||""}`.toLowerCase();
    return s.includes(q);
  });

  if (list.length === 0){
    const empty = document.createElement("div");
    empty.className = "msg";
    empty.style.display = "block";
    empty.textContent = "ç›®å‰æ²’æœ‰è²¼æ–‡ï¼ˆæˆ–æœå°‹çµæœç‚ºç©ºï¼‰ã€‚";
    feed.appendChild(empty);
    return;
  }

  list.forEach(p=>{
    const card = document.createElement("div");
    card.className = "postCard";

    const authorName = escapeHtml(p.author?.userName || p.user_name || "unknown");
    const authorEmail = escapeHtml(p.author?.email || p.Email || "");
    const t = fmtTime(p.createdAt || p.time);
    const likes = (p.likes ?? 0);

    const meta = document.createElement("div");
    meta.className = "postMeta";
    meta.innerHTML = `
      <div class="nameLine">
        <b>${authorName}</b>
        ${authorEmail ? `<span class="badge">${authorEmail}</span>` : ""}
      </div>
      <div class="time">${t}</div>
    `;

    const body = document.createElement("div");
    body.className = "postBody";
    body.innerHTML = escapeHtml(p.content || "");

    card.appendChild(meta);
    card.appendChild(body);

    const pic = normalizeImageUrl(p.picture || "");
    if (pic){
      const imgWrap = document.createElement("div");
      imgWrap.className = "imgWrap";
      imgWrap.innerHTML = `<img src="${escapeHtml(pic)}" alt="post image" />`;
      card.appendChild(imgWrap);
    }

    const footer = document.createElement("div");
    footer.className = "footerBar";
    footer.innerHTML = `<span>likes: ${likes}</span><span class="badge">from API</span>`;
    card.appendChild(footer);

    feed.appendChild(card);
  });
}

/* helpers */
function fillDemo(){
  const s = getSession();
  if (!s?.accessToken){
    showMsg($("postMsg"), "err", "å…ˆç™»å…¥ï¼ˆé»å·¦ä¸Šè§’é ­åƒï¼‰");
    return;
  }
  $("postContent").value = `ä»Šå¤© demo å¾ˆé †ï¼\nâ€” ${s.user?.userName || s.user?.email}`;
  clearPostImage();
  updateCharCount();
}

function updateCharCount(){
  const v = $("postContent").value || "";
  $("charCount").textContent = `${v.length} / 500`;
}

/* init bindings */
document.getElementById("authBtn").addEventListener("click", openAuth);
document.getElementById("postContent").addEventListener("input", updateCharCount);

syncWhoAmI();
uiSetTab("login");
showPage("home");
updateCharCount();
pingBackend();
loadPosts().catch(()=>{});
</script>
</body>
</html>
